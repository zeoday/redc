# Userdata 执行功能设计文档

## 概述

本文档描述了 RedC GUI 中用户数据脚本（Userdata）执行功能的设计与实现。该功能允许用户在 SSH 运维场景中，选择并执行预置的 userdata 模板脚本，支持交互式操作。

## 需求背景

1. **SSH 运维需求**：用户需要在远程机器上进行运维操作，包括执行自动化脚本
2. **交互式执行**：部分脚本需要用户交互，Web 终端的直接输入方式存在兼容性问题
3. **模板化管理**：userdata 脚本应作为独立模板管理，便于维护和扩展

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         RedC GUI                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐  │
│  │ SSH 运维弹窗 │    │ Web 终端    │    │ AI 场景页面     │  │
│  │ (SSHModal)  │    │(WebTerminal)│    │ (Cases/AIScene) │  │
│  └──────┬──────┘    └──────┬──────┘    └────────┬────────┘  │
│         │                  │                      │            │
│         └──────────────────┼──────────────────────┘            │
│                            │                                   │
│                    ┌───────┴───────┐                           │
│                    │ userdataTemplates │                        │
│                    │   (lib/)       │                          │
│                    └───────┬�───────┘                           │
│                            │                                   │
└────────────────────────────┼───────────────────────────────────┘
                             │
                    ┌────────┴────────┐
                    │   Wails JS      │
                    │   Bindings      │
                    └────────┬────────┘
                             │
┌────────────────────────────┼───────────────────────────────────┐
│                     Go Backend                                 │
├────────────────────────────┼───────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ ListUserdata    │  │ ExecUserdata    │  │ UploadUser   │ │
│  │ Templates       │  │ (远程非交互执行) │  │ dataScript   │ │
│  └────────┬────────┘  └────────┬────────┘  └──────┬───────┘ │
│           │                    │                   │          │
│           └────────────────────┴───────────────────┘          │
│                            │                                   │
│                    ┌───────┴───────┐                           │
│                    │  SSH Client   │                           │
│                    │  (sshutil)    │                           │
│                    └───────┬───────┘                           │
└────────────────────────────┼───────────────────────────────────┘
                             │
                    ┌────────┴────────┐
                    │   Remote Host   │
                    │   (SSH Target)  │
                    └─────────────────┘
```

### 核心模块

#### 1. 模板存储层

**本地模板目录**：`/Users/f0x/redc/templates/userdata-templates/`

```
userdata-templates/
├── basic-setup-bash/
│   ├── case.json          # 元数据
│   └── userdata           # 脚本内容
├── openclaw/
│   ├── case.json
│   └── userdata
├── n8n/
│   ├── case.json
│   └── userdata
└── ...
```

**case.json 字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| name | string | 英文名称 |
| nameZh | string | 中文名称 |
| type | string | 脚本类型 (bash/powershell) |
| category | string | 分类 (ai/basic/network 等) |
| url | string | 官方链接 |
| description | string | 描述信息 |
| installNotes | string | 安装说明 |
| user | string | 作者 |
| version | string | 版本号 |

#### 2. 后端服务层

**Go 函数接口**：

```go
// 列出所有 userdata 模板
func ListUserdataTemplates() ([]*UserdataTemplate, error)

// 在远程主机执行 userdata 脚本（非交互式）
func ExecUserdata(caseID string, script string) ExecCommandResult

// 上传 userdata 脚本到远程主机
func UploadUserdataScript(caseID string, scriptContent string, fileName string) FileTransferResult
```

#### 3. 前端组件层

**组件结构**：

- `SSHModal.svelte`：SSH 运维弹窗，包含"执行 Userdata"标签页
- `WebTerminal.svelte`：Web 终端组件，集成 userdata 上传功能
- `userdataTemplates.js`：模板加载工具函数
- `i18n.js`：国际化翻译

## 功能实现

### 场景一：SSH 运维弹窗执行

**用户流程**：

1. 在场景列表点击"运维"按钮
2. 弹窗打开，切换到"执行 Userdata"标签
3. 从下拉列表选择模板
4. 预览脚本内容
5. 点击"执行 Userdata"按钮
6. 后端通过 SSH 执行脚本
7. 显示执行结果（stdout/stderr）

**关键代码**：

```svelte
<!-- SSHModal.svelte -->
{:else if activeTab === 'userdata'}
  <div class="space-y-4">
    <select bind:value={selectedTemplate}>
      {#each userdataTemplates as template}
        <option value={template}>{template.nameZh || template.name}</option>
      {/each}
    </select>
    
    {#if selectedTemplate}
      <pre>{selectedTemplate.script}</pre>
      
      <button onclick={handleExecUserdata}>
        {t.execUserdata || '执行 Userdata'}
      </button>
    {/if}
    
    {#if userdataExecResult}
      <pre>{userdataExecResult.stdout}</pre>
      <pre>{userdataExecResult.stderr}</pre>
    {/if}
  </div>
{/if}
```

### 场景二：Web 终端执行

**用户流程**：

1. 在场景列表点击"终端"按钮
2. Web 终端连接 SSH
3. 点击工具栏"Userdata"按钮
4. 选择模板并预览
5. 点击"上传并执行"按钮
6. 脚本上传到远程 `/tmp/` 目录
7. 终端显示执行命令：`bash /tmp/xxx.sh`
8. 用户手动输入命令执行（支持交互）

**实现逻辑**：

```javascript
// WebTerminal.svelte
async function uploadAndShowCommand() {
  const fileName = `${selectedUserdataTemplate.name || 'userdata'}.sh`;
  
  // 上传脚本到远程
  const result = await UploadUserdataScript(caseId, script, fileName);
  
  if (result.success) {
    terminal.writeln(`脚本已上传到: /tmp/${fileName}`);
    terminal.writeln(`执行命令: bash /tmp/${fileName}`);
  }
}
```

### 场景三：AI 场景快速安装

**用户流程**：

1. 进入"专项模块" → "AI 场景"
2. 选择 AI 产品（如 OpenClaw、n8n、Dify）
3. 查看安装命令和官方链接
4. 一键复制安装命令
5. 在终端中执行

**界面展示**：

```
┌─────────────────────────────────────────┐
│  AI 场景                                 │
├─────────────────────────────────────────┤
│  [OpenClaw] [n8n] [Dify] [更多...]       │
├─────────────────────────────────────────┤
│  OpenClaw - 自动化 AI 任务平台           │
│                                         │
│  官网: https://openclaw.ai              │
│                                         │
│  安装命令:                               │
│  ┌─────────────────────────────────────┐│
│  │ curl -fsSL ... | bash              ││
│  └─────────────────────────────────────┘│
│  [复制]                                  │
│                                         │
│  描述: OpenClaw 是一个...                │
│                                         │
│  安装备注:                               │
│  - 首次启动需要配置 API Key             │
│  - 默认端口: 8080                       │
└─────────────────────────────────────────┘
```

## 技术要点

### 1. 模板动态加载

- 不使用缓存，每次打开弹窗时实时加载
- 支持按分类筛选（AI、基础、网络等）

### 2. SSH 连接复用

- Web 终端建立 SSH 连接后保持会话
- userdata 执行复用现有连接

### 3. 脚本传输方式

- **非交互执行**：通过 `session.Run()` 直接执行
- **交互执行**：上传到 `/tmp/` 后用户手动执行

### 4. 错误处理

- 连接失败：显示错误信息
- 执行超时：支持取消操作
- 权限问题：提示 chmod 失败

## 扩展性设计

### 添加新模板

1. 在 `userdata-templates/` 下创建新目录
2. 添加 `case.json` 元数据文件
3. 添加 `userdata` 脚本文件
4. 重新加载前端即可见

### 支持新脚本类型

当前支持：
- `bash`：Linux/macOS Shell 脚本
- `powershell`：Windows PowerShell 脚本

扩展方式：
1. 在 `case.json` 中添加 `type` 字段
2. 后端根据 type 选择解释器

## 安全考虑

1. **脚本来源**：只加载受信任的模板
2. **临时文件**：脚本上传到 `/tmp`，重启后自动清理
3. **权限控制**：需要 SSH 凭据才能执行

## 国际化

所有用户可见文本通过 `i18n.js` 管理：

```javascript
// 中文
execUserdata: '执行 Userdata',
selectTemplate: '选择模板',
scriptPreview: '脚本预览',
uploadAndExec: '上传并执行',

// English
execUserdata: 'Execute Userdata',
selectTemplate: 'Select Template',
scriptPreview: 'Script Preview',
uploadAndExec: 'Upload & Execute',
```

## 总结

该功能实现了 userdata 脚本的模板化管理，提供三种执行方式：

1. **SSH 运维弹窗**：非交互式执行，适合自动化任务
2. **Web 终端**：交互式执行，用户可控性强
3. **AI 场景页**：快速安装特定软件

设计遵循模块化、可扩展原则，便于后续添加更多模板和功能。
